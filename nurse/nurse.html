<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†å¸«ç…§è­·ç³»çµ± - å·¥ä½œç«™</title>
    <style>
        /* (CSS æ¨£å¼èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸ä¼¼ï¼Œåªæ–°å¢äº†å¾…åˆ†é…å€åŸŸçš„æ¨£å¼) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
        }

        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            color: #333;
        }

        .waiting-area {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .waiting-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .waiting-patient {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .waiting-patient button {
            margin-left: 10px;
            background: #20c997;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .waiting-patient button:hover {
            background: #1faa83;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .ward-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #ccc;
            position: relative;
        }

        .ward-card.occupied {
            border-left-color: #28a745;
        }

        .ward-card.isolated {
            border-left-color: #dc3545;
        }

        .ward-card.cleaning {
            border-left-color: #ffc107;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .ward-name {
            font-size: 1.2em;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: white;
            background: #6c757d;
        }

        .patient-info {
            margin-bottom: 15px;
        }

        .info-row {
            margin-bottom: 5px;
            color: #555;
        }

        .sign-status {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .sign-completed {
            color: #155724;
            background-color: #d4edda;
        }

        .sign-pending {
            color: #721c24;
            background-color: #f8d7da;
        }

        .action-area {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            cursor: pointer;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            transition: 0.3s;
        }

        .btn-care {
            background-color: #007bff;
            color: white;
            width: 100%;
        }

        .btn-care:hover {
            background-color: #0056b3;
        }

        .btn-care:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }

        .ward-select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 400px;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 5px;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>è­·ç†å¸«å·¥ä½œç«™ (Nurse Station)</h1>
        <div>ç•¶å‰è­·ç†å¸« ID: 1</div>
    </div>

    <div class="waiting-area">
        <h3>ğŸ  å¾…åˆ†é…ç—…æ‚£</h3>
        <div id="waitingList" class="waiting-list">
        </div>
    </div>

    <div class="dashboard-grid" id="wardList">
        <div style="text-align:center; width:100%">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="careModal" class="modal">
        <div class="modal-content">
            <h3>åŸ·è¡Œç…§è­· / ç”¨è—¥ç´€éŒ„</h3>
            <p>ç—…äºº: <span id="modalPatientName"></span></p>
            <textarea id="logContent" placeholder="è«‹è¼¸å…¥ç…§è­·å…§å®¹ã€é«”æº«ã€è¡€å£“æˆ–ç”¨è—¥ç‹€æ³..."></textarea>
            <div style="text-align: right;">
                <button onclick="closeModal('careModal')" style="background:#6c757d; color:white;">å–æ¶ˆ</button>
                <button onclick="submitCareLog()" style="background:#28a745; color:white;">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <div id="allocateModal" class="modal">
        <div class="modal-content">
            <h3>åˆ†é…ç—…æˆ¿</h3>
            <p>ç—…äºº: <span id="allocatePatientName"></span></p>
            <label>é¸æ“‡ç©ºç—…æˆ¿:</label>
            <select id="availableWards" class="ward-select">
            </select>
            <div style="text-align: right; margin-top: 15px;">
                <button onclick="closeModal('allocateModal')" style="background:#6c757d; color:white;">å–æ¶ˆ</button>
                <button onclick="submitAllocation()" style="background:#007bff; color:white;">ç¢ºèªåˆ†é…</button>
            </div>
        </div>
    </div>

    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h3>è½‰ç§»ç—…æˆ¿</h3>
            <p>å°‡ <span id="transferPatientName"></span> å¾ <span id="transferOldWard"></span> è½‰ç§»åˆ°:</p>
            <label>é¸æ“‡æ–°ç—…æˆ¿ (å¿…é ˆæ˜¯ç©ºåºŠ):</label>
            <select id="transferAvailableWards" class="ward-select">
            </select>
            <div style="text-align: right; margin-top: 15px;">
                <button onclick="closeModal('transferModal')" style="background:#6c757d; color:white;">å–æ¶ˆ</button>
                <button onclick="submitTransfer()" style="background:#dc3545; color:white;">ç¢ºèªè½‰ç§»</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'api';   // ä¹‹å¾Œæœƒè®Šæˆ api/xxx.php
        const NURSE_ID = 1;
        let currentPatientId = null;
        let currentSignStatus = null;
        let currentOldWardId = null;
        let allWards = []; // ç”¨æ–¼å­˜å„²æ‰€æœ‰ç—…æˆ¿ (åŒ…å«ç©ºç—…æˆ¿) çš„åˆ—è¡¨

        // --- æ ¸å¿ƒè³‡æ–™è¼‰å…¥ ---
        async function loadDashboard() {
            try {
                // 1. è®€å–å„€è¡¨æ¿è³‡æ–™
                const wardRes = await fetch(`${API_URL}/dashboard.php`);
                const wardJson = await wardRes.json();
                allWards = wardJson.data;
                renderWards(allWards);

                // 2. è®€å–å¾…åˆ†é…ç—…æ‚£
                const waitingRes = await fetch(`${API_URL}/waiting_patients.php`);
                const waitingJson = await waitingRes.json();
                renderWaitingPatients(waitingJson.data);

            } catch (error) {
                console.error(error);
                alert("å¾Œç«¯é€£ç·šå¤±æ•—ï¼š" + error);
            }
        }

        // --- æ¸²æŸ“é‚è¼¯ ---

        function getStatusColor(status) {
            if (status === 'occupied') return '#28a745';
            if (status === 'isolated') return '#dc3545';
            if (status === 'cleaning') return '#ffc107';
            return '#6c757d';
        }

        // æ¸²æŸ“ç—…æˆ¿å¡ç‰‡ (ä¿®æ­£ç‰ˆ)
        function renderWards(wards) {
            const container = document.getElementById('wardList');
            container.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

            wards.forEach(ward => {
                const isSigned = ward.doctor_sign_status === 'Completed';
                const hasPatient = ward.patient_id != null;

                let signBadge = '';
                if (hasPatient) {
                    signBadge = isSigned
                        ? `<span class="sign-status sign-completed">âœ… é†«å¸«å·²ç°½æ ¸</span>`
                        : `<span class="sign-status sign-pending">âš  é†«å¸«æœªç°½æ ¸</span>`;
                }

                const btnDisabled = !hasPatient || !isSigned;
                const btnText = !hasPatient ? 'ç„¡ç—…äºº' : (!isSigned ? 'éœ€é†«å¸«ç°½æ ¸æ‰å¯åŸ·è¡Œ' : 'åŸ·è¡Œç…§è­· & ç”¨è—¥');

                // è½‰ç§»æŒ‰éˆ•é‚è¼¯ (å¿…é ˆåœ¨è¿´åœˆå…§å®šç¾©ï¼Œæ‰èƒ½ä½¿ç”¨ ward è®Šæ•¸)
                const transferBtn = hasPatient && ward.ward_status === 'occupied' ?
                    `<button style="background:#ff7f50; color:white; width:100%" onclick='openTransferModal(${ward.patient_id}, ${JSON.stringify(ward.patient_name)}, ${ward.ward_id})'>è½‰ç§»ç—…æˆ¿</button>` : '';

                // è¾¦ç†å‡ºé™¢æŒ‰éˆ•é‚è¼¯ (å¿…é ˆåœ¨è¿´åœˆå…§å®šç¾©)
                const dischargeBtn = hasPatient && ward.ward_status === 'occupied' ?
                    `<button style="background:#000080; color:white; width:100%" onclick="dischargePatient(${ward.patient_id}, '${ward.patient_name}')">è¾¦ç†å‡ºé™¢</button>` : '';

                const html = `
            <div class="ward-card ${ward.ward_status}">
                <div class="card-header">
                    <span class="ward-name">${ward.ward_name} (ID: ${ward.ward_id})</span>
                    <span class="status-badge" style="background:${getStatusColor(ward.ward_status)}">${ward.ward_status}</span>
                </div>
                
                <div class="patient-info">
                    ${hasPatient ? `
                        <div class="info-row"><strong>ğŸ‘¤ ç—…äºº:</strong> ${ward.patient_name} (ID: ${ward.patient_id})</div>
                        <div class="info-row"><strong>ğŸ’‰ è¨ºæ–·:</strong> ${ward.diagnosis || 'ç„¡'}</div>
                        <div class="info-row"><strong>ğŸ’Š è™•æ–¹:</strong> ${ward.prescription || 'ç„¡'}</div>
                        <div class="info-row">${signBadge}</div>
                    ` : `<div style="color:#999; padding: 20px 0;">ç›®å‰ç©ºåºŠ</div>`}
                </div>

                <div class="action-area">
                    <button class="btn-care" 
                        onclick="openCareModal(${ward.patient_id}, '${ward.patient_name}', '${ward.doctor_sign_status}')" 
                        ${btnDisabled ? 'disabled' : ''}>
                        ${btnText}
                    </button>
                    ${transferBtn}
                    ${dischargeBtn} 
                    
                    <label style="font-size:0.8em; margin-top:5px;">ç—…æˆ¿ç‹€æ…‹ç®¡ç†:</label>
                    <select class="ward-select" onchange="updateWardStatus(${ward.ward_id}, this.value)">
                        <option value="occupied" ${ward.ward_status === 'occupied' ? 'selected' : ''} ${hasPatient ? '' : 'disabled'}>ä½¿ç”¨ä¸­ (Occupied)</option>
                        <option value="empty" ${ward.ward_status === 'empty' ? 'selected' : ''}>ç©ºåºŠ (Empty)</option>
                        <option value="isolated" ${ward.ward_status === 'isolated' ? 'selected' : ''}>éš”é›¢ (Isolated)</option>
                        <option value="cleaning" ${ward.ward_status === 'cleaning' ? 'selected' : ''}>æ¸…æ½”ä¸­ (Cleaning)</option>
                    </select>
                </div>
            </div>
        `;
                container.innerHTML += html;
            });




        }

        // nurse_dashboard.html - åœ¨ <script> æ¨™ç±¤å…§æ–°å¢

        // æäº¤å‡ºé™¢ç”³è«‹
        async function dischargePatient(patientId, patientName) {
            if (!confirm(`ç¢ºå®šè¦ç‚ºç—…æ‚£ ${patientName} (ID: ${patientId}) è¾¦ç†å‡ºé™¢æ‰‹çºŒå—ï¼Ÿ`)) {
                return;
            }

            const res = await fetch(`${API_URL}/discharge_patient.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_id: patientId
                })
            });

            const result = await res.json();
            alert(result.success ? result.message : 'å‡ºé™¢è¾¦ç†å¤±æ•—ï¼š' + result.message);

            loadDashboard();
        }

        // ... (å…¶ä»– JavaScript å‡½æ•¸ï¼Œå¦‚ submitCareLog, submitAllocation, submitTransfer ç­‰)

        // æ¸²æŸ“å¾…åˆ†é…ç—…æ‚£åˆ—è¡¨
        function renderWaitingPatients(patients) {
            const container = document.getElementById('waitingList');
            container.innerHTML = '';

            if (patients.length === 0) {
                container.innerHTML = 'æ²’æœ‰ç­‰å¾…åˆ†é…ç—…æˆ¿çš„æ–°ç—…æ‚£ã€‚';
                return;
            }

            patients.forEach(p => {
                const html = `
                    <div class="waiting-patient">
                        <span>ğŸ‘¤ ${p.name} (ID: ${p.patient_id})</span>
                        <button onclick="openAllocateModal(${p.patient_id}, '${p.name}')">åˆ†é…ç—…æˆ¿</button>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- Modal é–‹å•Ÿ/é—œé–‰ ---

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // é–‹å•Ÿç…§è­· Modal
        function openCareModal(patientId, name, signStatus) {
            // ... (åŒèˆŠç‰ˆé‚è¼¯)
            if (!patientId || signStatus !== 'Completed') {
                if (patientId) alert('âš  é†«å¸«å°šæœªç°½æ ¸ï¼Œç„¡æ³•åŸ·è¡Œç…§è­·ï¼');
                return;
            }
            currentPatientId = patientId;
            currentSignStatus = signStatus;
            document.getElementById('modalPatientName').innerText = name;
            document.getElementById('logContent').value = '';
            document.getElementById('careModal').style.display = 'flex';
        }

        // é–‹å•Ÿåˆ†é… Modal
        function openAllocateModal(patientId, name) {
            currentPatientId = patientId;
            document.getElementById('allocatePatientName').innerText = name;

            const select = document.getElementById('availableWards');
            select.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

            // æ‰¾å‡ºæ‰€æœ‰ empty ç‹€æ…‹çš„ç—…æˆ¿
            const emptyWards = allWards.filter(w => w.ward_status === 'empty');

            if (emptyWards.length === 0) {
                alert('ç›®å‰æ²’æœ‰å¯ç”¨çš„ç©ºç—…æˆ¿é€²è¡Œåˆ†é…ã€‚');
                return;
            }

            emptyWards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.ward_id;
                option.innerText = `${ward.ward_name} (ID: ${ward.ward_id})`;
                select.appendChild(option);
            });

            document.getElementById('allocateModal').style.display = 'flex';
        }

        // é–‹å•Ÿè½‰ç§» Modal
        function openTransferModal(patientId, name, oldWardId) {
            currentPatientId = patientId;
            currentOldWardId = oldWardId;
            document.getElementById('transferPatientName').innerText = name;
            document.getElementById('transferOldWard').innerText = oldWardId;

            const select = document.getElementById('transferAvailableWards');
            select.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

            const emptyWards = allWards.filter(w => w.ward_status === 'empty');

            if (emptyWards.length === 0) {
                alert('ç›®å‰æ²’æœ‰å¯ç”¨çš„ç©ºç—…æˆ¿é€²è¡Œè½‰ç§»ã€‚');
                return;
            }

            emptyWards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.ward_id;
                option.innerText = `${ward.ward_name} (ID: ${ward.ward_id})`;
                select.appendChild(option);
            });

            document.getElementById('transferModal').style.display = 'flex';
        }

        // --- æäº¤é‚è¼¯ ---

        // æäº¤ç…§è­·ç´€éŒ„
        async function submitCareLog() {
            const content = document.getElementById('logContent').value.trim();
            if (!content) return alert('è«‹è¼¸å…¥ç…§è­·å…§å®¹');

            const res = await fetch(`${API_URL}/care_log.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nurse_id: NURSE_ID,
                    patient_id: currentPatientId,
                    log_content: content,
                    doctor_sign_status: currentSignStatus
                })
            });

            const result = await res.json();
            alert(result.success ? 'ç…§è­·ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼' : 'å¤±æ•—ï¼š' + result.message);
            closeModal('careModal');
            loadDashboard();
        }

        // æäº¤åˆ†é…ç—…æˆ¿
        async function submitAllocation() {
            const wardId = document.getElementById('availableWards').value;
            if (!wardId) return alert("è«‹é¸æ“‡ç—…æˆ¿");

            const res = await fetch(`${API_URL}/allocate_ward.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_id: currentPatientId,
                    ward_id: wardId
                })
            });

            const result = await res.json();
            alert(result.success ? 'ç—…æˆ¿åˆ†é…æˆåŠŸï¼' : 'åˆ†é…å¤±æ•—ï¼š' + result.message);

            closeModal('allocateModal');
            loadDashboard();
        }


        // æäº¤è½‰ç§»ç—…æˆ¿
        async function submitTransfer() {
            const newWardId = document.getElementById('transferAvailableWards').value;
            if (!newWardId) return alert('è«‹é¸æ“‡æ–°ç—…æˆ¿');
            if (newWardId == currentOldWardId) return alert('æ–°ç—…æˆ¿ä¸èƒ½èˆ‡èˆŠç—…æˆ¿ç›¸åŒï¼');

            const res = await fetch(`${API_URL}/transfer_ward.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_id: currentPatientId,
                    new_ward_id: newWardId        // â˜… ç¬¦åˆå¾Œç«¯è¦æ±‚
                })
            });

            const result = await res.json();
            alert(result.success ? result.message : 'è½‰ç§»å¤±æ•—ï¼š' + result.message);

            closeModal('transferModal');
            loadDashboard();
        }




        // æ›´æ–°ç—…æˆ¿ç‹€æ…‹ (ç¶­æŒèˆŠç‰ˆé‚è¼¯)
        async function updateWardStatus(wardId, newStatus) {
            // ... (åŒèˆŠç‰ˆé‚è¼¯)
            try {
                const res = await fetch(`${API_URL}/update_ward_status.php?ward_id=${wardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await res.json();
                if (result.success) {
                    console.log(`ç—…æˆ¿ ${wardId} ç‹€æ…‹æ›´æ–°æˆåŠŸ: ${newStatus}`);
                } else {
                    alert('æ›´æ–°ç‹€æ…‹å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•æ›´æ–°ç—…æˆ¿ç‹€æ…‹');
            }
            loadDashboard();
        }

        // åˆå§‹åŒ–
        loadDashboard();
    </script>
</body>

</html>